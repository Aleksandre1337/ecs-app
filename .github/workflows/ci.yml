name: CI Pipeline

on:
  push:
    branches: "main"

env:
  ECR_REPOSITORY: ecs-demo-frontend

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN || '' }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Get latest tag and bump version
        id: bump-version
        run: |
          # Fetch all tags
          git fetch --tags
          
          # Get latest tag (assumes format x.y.z)
          LATEST_TAG=$(git tag -l | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No existing tag found, using 0.0.0"
            LATEST_TAG="0.0.0"
          fi
          
          echo "Latest tag: $LATEST_TAG"
          
          # Parse version components
          IFS='.' read -r major minor patch <<< "$LATEST_TAG"
          
          # Bump patch version
          NEW_PATCH=$((patch + 1))
          NEW_TAG="${major}.${minor}.${NEW_PATCH}"
          
          echo "New tag: $NEW_TAG"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
      
      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY || 'ecs-demo-frontend' }}
          IMAGE_TAG: ${{ github.sha }}
          VERSION_TAG: ${{ steps.bump-version.outputs.new_tag }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$VERSION_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REPOSITORY:latest
      
      - name: Test Docker image
        run: |
          docker run -d --name test-app -p 8080:80 ecs-demo-frontend:latest
          sleep 5
          curl -f http://localhost:8080/health || exit 1
          docker stop test-app
      
      - name: Push to ECR (main branch only)
        if: github.ref == 'refs/heads/main'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY || 'ecs-demo-frontend' }}
          IMAGE_TAG: ${{ github.sha }}
          VERSION_TAG: ${{ steps.bump-version.outputs.new_tag }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$VERSION_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
      
      - name: Get latest tag and bump version
        id: bump-version
        run: |
          # Fetch all tags
          git fetch --tags
          
          # Get latest tag (assumes format x.y.z)
          LATEST_TAG=$(git tag -l | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No existing tag found, using 0.0.0"
            LATEST_TAG="0.0.0"
          fi
          
          echo "Latest tag: $LATEST_TAG"
          
          # Parse version components
          IFS='.' read -r major minor patch <<< "$LATEST_TAG"
          
          # Bump patch version
          NEW_PATCH=$((patch + 1))
          NEW_TAG="${major}.${minor}.${NEW_PATCH}"
          
          echo "New tag: $NEW_TAG"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY || 'ecs-demo-frontend' }}
          NEW_TAG: ${{ steps.bump-version.outputs.new_tag }}
        run: |
          # Create release body
          cat > release-body.md << EOF
          ## Build Information
          
          - **Version**: $NEW_TAG
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          - **Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - **Actor**: ${{ github.actor }}
          
          ## Docker Images
          
          \`\`\`
          $ECR_REGISTRY/$ECR_REPOSITORY:$NEW_TAG
          $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }}
          $ECR_REGISTRY/$ECR_REPOSITORY:latest
          \`\`\`
          
          ## Deployment
          
          Pull the image by version:
          \`\`\`bash
          docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$NEW_TAG
          \`\`\`
          
          Or by commit SHA:
          \`\`\`bash
          docker pull $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }}
          \`\`\`
          EOF
          
          # Create the release
          gh release create "$NEW_TAG" \
            --title "Release $NEW_TAG" \
            --notes-file release-body.md \
            --target ${{ github.sha }}
